/**
* @version		$Id: fckeditor.php 1154 18-1-2008 AW
* @package		JoomlaFCK
* @copyright	Copyright (C) 2006 - 2008 WebXSolution Ltd. All rights reserved.
* @license		Creative Commons Licence
* The code for this additional work for the FCKeditor has been  been written/modified by WebxSolution Ltd.
* You may not copy or distribute the work without written consent
* from WebxSolution Ltd.
*/
var getFunctionsUrl = "suggest.php?"; var phpHelpUrl=""; var httpRequestKeyword = ""; var userKeyword = ""; var suggestions = 0; var suggestionMaxLength = 50; var isKeyUpDownPressed = false; var autocompletedKeyword = ""; var hasResults = false; var timeoutId = -1; var position = -1; var oCache = new Object(); var minVisiblePosition = 0; var maxVisiblePosition = 9; var debugMode = true; var LinkNames = null; var FCKXml = new FCKXml(); var CacheKeyword = ""; var dialog = window.parent; var oEditor = window.parent.InnerDialogLoaded(); var FCK = oEditor.FCK; var FCKLang = oEditor.FCKLang; var FCKdbLink = oEditor.FCKdbLink;phpHelpUrl = FCK.Config["SitePath"];window.onload = init; var eSelected = dialog.Selection.GetSelection().MoveToAncestorNode( 'A' ); if ( eSelected )FCK.Selection.SelectNode( eSelected ); function LoadSelected(){if ( !eSelected ) return; var txtHref=document.getElementById('txtHref'); var txtCaption=document.getElementById('txtCaption');txtHref.value = eSelected.href.replace(/^https?.+\/index.php/,'index.php');txtCaption.value =  (eSelected.innerText ? eSelected.innerText : eSelected.textContent);}; function Ok(){var txtHref=document.getElementById('txtHref'); var txtCaption=document.getElementById('txtCaption'); if ( document.getElementById('txtHref').value.length > 0 )FCKdbLink.Add( txtHref.value,txtCaption.value ); return true ;}; function init(){var oKeyword = document.getElementById("keyword");oKeyword.value = "";oKeyword.focus();setTimeout("checkForChanges()",500);LoadSelected();	window.parent.SetOkButton( true ) ;}; function addToCache(keyword,values){oCache[keyword] = new Array(); for(i=0;i<values.length;i++)oCache[keyword][i] = values[i];}; function inCacheObj(keyword){for (var key in oCache){if (key.toLowerCase() == keyword.toLowerCase()){CacheKeyword = key; return true;}}; return false;}; function checkCache(keyword){if(inCacheObj(keyword)) return true; for(i=keyword.length-2;i>=0;i--){var currentKeyword =  keyword.length > 1 ?  keyword.substring(0,i+1) : keyword; if(inCacheObj(currentKeyword)){var cacheResults = oCache[CacheKeyword]; var keywordResults = new Array(); var keywordResultsSize = 0; for(j=0;j<cacheResults.length;j++){if(cacheResults[j].toLowerCase().indexOf(keyword.toLowerCase()) == 0){keywordResults[keywordResultsSize++] = cacheResults[j];}};addToCache(keyword,keywordResults); return true;}}; return false;}; function getSuggestions(keyword,oFCKXml){if(keyword != "" && !isKeyUpDownPressed){var isInCache = checkCache(keyword); if(isInCache == true){httpRequestKeyword=keyword;userKeyword=keyword;displayResults(keyword,oCache[CacheKeyword],oFCKXml);} else{try{if (oFCKXml.xmlHttpGetSuggestions.readyState == 4 ||oFCKXml.xmlHttpGetSuggestions.readyState == 0){httpRequestKeyword = keyword;userKeyword = keyword;FCKXml.LoadUrl(getFunctionsUrl +"keyword="+ encode(keyword),handleGettingSuggestions);} else{userKeyword = keyword; if(timeoutId != -1)clearTimeout(timeoutId);timeoutId = setTimeout("getSuggestions(userKeyword,FCKXml);",500);}} catch(e){displayError("Can't connect to server:\n" + e.toString());}}}}; function xmlToArray(resultsXml){var resultsArray= new Array(); for(i=0;i<resultsXml.length;i++)resultsArray[i]=resultsXml.item(i).firstChild.data; return resultsArray;}; function handleGettingSuggestions(oFCKXml){try{updateSuggestions(oFCKXml);} catch(e){displayError(e.toString());}}; function updateSuggestions(oFCKXml){var response = oFCKXml.xmlHttpGetSuggestions.responseText; if (response.indexOf("ERRNO") >= 0|| response.indexOf("error:") >= 0|| response.length == 0) throw(response.length == 0 ? "Void server response." : response);response =  oFCKXml.DOMDocument; if(response.childNodes.length){nameArray= oFCKXml.ToArray("name");}; if(httpRequestKeyword == userKeyword){displayResults(httpRequestKeyword,nameArray,oFCKXml);} else{addToCache(httpRequestKeyword,nameArray);}}; function displayResults(keyword,results_array,oFCKXml){var div = "<table>"; var pidArray = new Array(); var linkArray = new Array();response = oFCKXml.DOMDocument;pidArray=  oFCKXml.ToArray("pid");linkArray = oFCKXml.ToArray("link"); if(!oCache[keyword] && keyword){addToCache(keyword,results_array);}; if(results_array.length == 0){div += "<tr><td>No results found for <strong>" + keyword +"</strong></td></tr>";hasResults = false;suggestions = 0;} else{position = -1;isKeyUpDownPressed = false;hasResults = true;suggestions = oCache[keyword].length;LinkNames = null;LinkNames  = new Object(); for (var i=0;i< oCache[keyword].length;i++){var offset = 0; for(var j=i+offset;j< nameArray.length;j++){if(nameArray[j].toLowerCase().indexOf(keyword.toLowerCase()) == 0){offset = j; break;}};pidArray[offset] = linkArray[offset] + (pidArray[offset] > 0 ? "&amp;Itemid=" + pidArray[offset] : '');crtFunction = oCache[keyword][i];LinkNames["a" + i] =  crtFunction;OnMtxtHref='onclick="' + "AssignValues('" + pidArray[offset]+ "',this);return false;" + '"';crtFunctionLink = crtFunction; while(crtFunctionLink.indexOf("_") !=-1)crtFunctionLink = crtFunctionLink.replace("_","-");div += "<tr id=\"tr" + i +"\" onclick='return false;' ondblclick='handleOnMouseClick(this);' " +"onmouseover='handleOnMouseOver(this);' " +"onmouseout='handleOnMouseOut(this);'>" +"<td align='left'><a "+OnMtxtHref +"id=\"a" + i +"\" href='" + phpHelpUrl + '/';div+=pidArray[offset]; if(crtFunction.length <= suggestionMaxLength){div += "' title='Double click this link to view page'><b>" +crtFunction.substring(0,httpRequestKeyword.length) +"</b>";div += crtFunction.substring(httpRequestKeyword.length,crtFunction.length) +"</a></td></tr>";} else{if(httpRequestKeyword.length < suggestionMaxLength){div += "'><b>" +crtFunction.substring(0,httpRequestKeyword.length) +"</b>";div += crtFunction.substring(httpRequestKeyword.length,suggestionMaxLength) +"</a></td></tr>";} else{div += "'><b>" +crtFunction.substring(0,suggestionMaxLength) +"</b></td></tr>"}}}};div += "</table>"; var oSuggest = document.getElementById("suggest"); var oScroll = document.getElementById("scroll");oScroll.scrollTop = 0;oSuggest.innerHTML = div;oScroll.style.visibility = "visible"; if(results_array.length > 0)autocompleteKeyword();}; function checkForChanges(){var elem= document.getElementById("keyword"); var keyword = elem.value; if(keyword == ""){hideSuggestions();userKeyword="";httpRequestKeyword=""; document.getElementById("suggest").innerHTML = "";};setTimeout("checkForChanges()",500); if(keyword.length == 1 && !document.getElementById("tr0") || (userKeyword != keyword  && (!isKeyUpDownPressed) && autocompletedKeyword != keyword)|| (keyword.length > 0 && !document.getElementById("tr0")) )getSuggestions(keyword,FCKXml);}; function deselectAll(){for(i=0;i<suggestions;i++){var oCrtTr = document.getElementById("tr" + i);oCrtTr.className = "";}}; function handleOnMouseOver(oTr){deselectAll();oTr.className = "highlightrow";position = oTr.id.substring(2,oTr.id.length);}; function handleOnMouseOut(oTr){oTr.className = "";position = -1;}; function handleOnMouseClick(otr){window.open( document.getElementById("a" + otr.id.replace("tr","")).href,'open_window','menubar,toolbar,location,directories,status,scrollbars,resizable,dependent,width=640,height=480,left=0,top=0');}; function AssignValues(link,elem){document.getElementById("txtHref").value= link; document.getElementById("txtCaption").value= LinkNames[elem.id];}; function encode(uri){if (encodeURIComponent){return encodeURIComponent(uri);}; if (escape){return escape(uri);}}; function hideSuggestions(){var oScroll = document.getElementById("scroll"); var elem= document.getElementById("keyword"); if(elem.value == "")   	oScroll.style.visibility = "hidden";}; function selectRange(oText,start,length){if (oText.setSelectionRange){oText.setSelectionRange(start,length);} else if (oText.createTextRange){var oRange = oText.createTextRange();oRange.moveStart("character",start);oRange.moveEnd("character",length - oText.value.length);oRange.select();};oText.focus();}; function autocompleteKeyword(){if(document.getElementById("tr0")){var oKeyword = document.getElementById("keyword");position=0;deselectAll(); document.getElementById("tr0").className="highlightrow";selectRange(oKeyword,httpRequestKeyword.length,oKeyword.value.length);autocompletedKeyword=oKeyword.value;}}; function displayError(message){alert("Error accessing the server! "+(debugMode ? "\n" + message : ""));};